{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<div class="row mb-5">
    <div class="col-12 text-center py-5">
        <div class="mb-4">
            <h1 class="display-4 fw-bold text-primary mb-3" style="text-shadow: 0 2px 10px rgba(52, 152, 219, 0.3);">
                <i class="bi bi-graph-up-arrow me-2"></i>A股分析系统
            </h1>
            <p class="lead text-muted mb-4">专业的股票数据分析与选股工具</p>
        </div>
        <div class="d-flex justify-content-center">
            <div class="w-100" style="max-width: 600px; position: relative;">
                <div class="input-group input-group-lg shadow-sm" style="border-radius: 50px; overflow: hidden;">
                    <span class="input-group-text bg-white border-end-0" style="border-radius: 50px 0 0 50px;">
                        <i class="bi bi-search text-secondary"></i>
                    </span>
                    <input type="text" class="form-control border-start-0 border-end-0" id="searchInput" 
                           placeholder="输入股票代码或名称 (如: 000001)" onkeypress="handleEnter(event)" oninput="handleSearchInput(event)">
                    <button class="btn btn-primary" type="button" onclick="searchStock()" style="border-radius: 0 50px 50px 0;">
                        <i class="bi bi-search me-1"></i>查询股票
                    </button>
                </div>
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row g-4 mb-5">
    <div class="col-md-3 col-sm-6">
        <div class="metric-card h-100 metric-card-primary">
            <div class="metric-value text-primary" id="totalStocks">-</div>
            <div class="metric-label">股票总数</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="metric-card h-100 metric-card-danger">
            <div class="metric-value text-danger" id="upCount">-</div>
            <div class="metric-label">上涨家数</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="metric-card h-100 metric-card-success">
            <div class="metric-value text-success" id="downCount">-</div>
            <div class="metric-label">下跌家数</div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6">
        <div class="metric-card h-100 metric-card-warning">
            <div class="metric-value text-warning" id="avgChange">-</div>
            <div class="metric-label">平均涨幅</div>
        </div>
    </div>
</div>

<!-- Market Overview -->
<div class="row g-4 mb-5">
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-trophy me-2"></i>涨幅排行</span>
                <span class="badge bg-light text-dark">TOP 10</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>代码</th>
                                <th>名称</th>
                                <th>价格</th>
                                <th>涨跌幅</th>
                            </tr>
                        </thead>
                        <tbody id="topGainers">
                            <tr><td colspan="4" class="text-center py-4">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <span><i class="bi bi-arrow-down-circle me-2"></i>跌幅排行</span>
                <span class="badge bg-light text-dark">TOP 10</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>代码</th>
                                <th>名称</th>
                                <th>价格</th>
                                <th>涨跌幅</th>
                            </tr>
                        </thead>
                        <tbody id="topLosers">
                            <tr><td colspan="4" class="text-center py-4">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row g-4 mb-5">
    <div class="col-md-3 col-sm-6">
        <a href="/analysis" class="text-decoration-none">
            <div class="quick-action-card quick-action-primary h-100">
                <i class="bi bi-graph-up"></i>
                <span>技术分析</span>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="/screening" class="text-decoration-none">
            <div class="quick-action-card quick-action-success h-100">
                <i class="bi bi-funnel"></i>
                <span>智能选股</span>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="/sectors" class="text-decoration-none">
            <div class="quick-action-card quick-action-info h-100">
                <i class="bi bi-grid"></i>
                <span>行业板块</span>
            </div>
        </a>
    </div>
    <div class="col-md-3 col-sm-6">
        <a href="/compare" class="text-decoration-none">
            <div class="quick-action-card quick-action-warning h-100">
                <i class="bi bi-bar-chart-line"></i>
                <span>股票对比</span>
            </div>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Load market data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadMarketData();
});

let searchTimeout = null;

function handleSearchInput(event) {
    const keyword = event.target.value.trim();
    const resultsDiv = document.getElementById('searchResults');
    
    // 清除之前的定时器
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // 如果输入为空，隐藏结果
    if (!keyword) {
        resultsDiv.style.display = 'none';
        return;
    }
    
    // 防抖：延迟300ms后再搜索
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/search?q=${encodeURIComponent(keyword)}&limit=10`);
            const result = await response.json();
            
            if (result.success && result.data.length > 0) {
                const html = result.data.map(stock => `
                    <a class="dropdown-item" href="/stock/${stock.code}">
                        <span class="fw-bold">${stock.code}</span>
                        <span class="text-muted ms-2">${stock.name}</span>
                        <span class="badge bg-secondary ms-2">${stock.market}</span>
                    </a>
                `).join('');
                
                resultsDiv.innerHTML = html;
                resultsDiv.style.display = 'block';
            } else {
                resultsDiv.style.display = 'none';
            }
        } catch (error) {
            console.error('搜索失败:', error);
            resultsDiv.style.display = 'none';
        }
    }, 300);
}

function handleEnter(event) {
    if (event.key === 'Enter') {
        searchStock();
    }
}

function searchStock() {
    const code = document.getElementById('searchInput').value.trim();
    if (code) {
        window.location.href = `/stock/${code}`;
    }
}

// 点击页面其他地方时隐藏搜索结果
document.addEventListener('click', function(event) {
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    if (searchInput && searchResults) {
        const searchContainer = searchInput.closest('.text-center') || searchInput.closest('.mx-auto');
        if (searchContainer && !searchContainer.contains(event.target)) {
            searchResults.style.display = 'none';
        }
    }
});

async function loadMarketData() {
    try {
        const response = await fetch('/api/stock_list');
        const result = await response.json();
        
        console.log('API Response:', result);
        
        if (result.success) {
            const stocks = result.data;
            
            // Update stats - 使用API返回的统计数据（基于全部3742只股票）
            document.getElementById('totalStocks').textContent = result.total_count || 0;
            document.getElementById('upCount').textContent = result.up_count || 0;
            document.getElementById('downCount').textContent = result.down_count || 0;
            
            const avgChange = result.avg_change_pct || 0;
            const avgChangeElem = document.getElementById('avgChange');
            avgChangeElem.textContent = (avgChange > 0 ? '+' : '') + avgChange.toFixed(2) + '%';
            avgChangeElem.className = avgChange >= 0 ? 'metric-value text-danger' : 'metric-value text-success';
            
            // Top gainers
            const gainers = [...stocks].sort((a, b) => b.change_pct - a.change_pct).slice(0, 10);
            const gainersHtml = gainers.map(s => `
                <tr>
                    <td><a href="/stock/${s.code}" class="text-decoration-none">${s.code}</a></td>
                    <td>${s.name}</td>
                    <td>${s.price?.toFixed(2) || '-'}</td>
                    <td class="up">+${s.change_pct?.toFixed(2) || '-'}%</td>
                </tr>
            `).join('');
            document.getElementById('topGainers').innerHTML = gainersHtml;
            
            // Top losers
            const losers = [...stocks].sort((a, b) => a.change_pct - b.change_pct).slice(0, 10);
            const losersHtml = losers.map(s => `
                <tr>
                    <td><a href="/stock/${s.code}" class="text-decoration-none">${s.code}</a></td>
                    <td>${s.name}</td>
                    <td>${s.price?.toFixed(2) || '-'}</td>
                    <td class="down">${s.change_pct?.toFixed(2) || '-'}%</td>
                </tr>
            `).join('');
            document.getElementById('topLosers').innerHTML = losersHtml;
        } else {
            console.error('API Error:', result.error);
        }
    } catch (error) {
        console.error('Failed to load market data:', error);
    }
}
</script>
{% endblock %}