{% extends "base.html" %}

{% block title %}股票详情 - {{ code }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">首页</a></li>
                <li class="breadcrumb-item active">{{ code }}</li>
            </ol>
        </nav>
        <h2 class="text-primary mb-3">
            <i class="bi bi-graph-up me-2"></i>{{ code }}
            <small class="text-muted fs-5" id="stockName">加载中...</small>
        </h2>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="analyzeStock()">
                <i class="bi bi-graph-up me-2"></i>技术分析
            </button>
            <button class="btn btn-outline-success" onclick="addToCompare()">
                <i class="bi bi-bar-chart-line me-2"></i>加入对比
            </button>
            <button class="btn btn-outline-info" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise me-2"></i>刷新数据
            </button>
        </div>
    </div>
</div>

<!-- Real-time Data -->
<div class="row mb-4" id="realtimeSection">
    <div class="col-md-3 mb-3">
        <div class="metric-card">
            <div class="metric-value text-primary" id="currentPrice">-</div>
            <div class="metric-label">最新价</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-card">
            <div class="metric-value" id="changePct">-</div>
            <div class="metric-label">涨跌幅</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-card">
            <div class="metric-value text-info" id="highPrice">-</div>
            <div class="metric-label">最高价</div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="metric-card">
            <div class="metric-value text-warning" id="lowPrice">-</div>
            <div class="metric-label">最低价</div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-12">
        <div class="chart-container">
            <h5 class="mb-3">
                <i class="bi bi-graph-up me-2"></i>价格走势图
                <div class="btn-group btn-group-sm float-end">
                    <button class="btn btn-outline-secondary" onclick="loadChart(30)">30天</button>
                    <button class="btn btn-outline-secondary active" onclick="loadChart(60)">60天</button>
                    <button class="btn btn-outline-secondary" onclick="loadChart(90)">90天</button>
                </div>
            </h5>
            <div class="position-relative">
                <canvas id="chartCanvas" width="100%" height="400"></canvas>
                <div id="chartPlaceholder" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center text-center text-muted bg-white bg-opacity-75" style="display: none; z-index: 10;">
                    <div class="spinner mb-3"></div>
                    <p>加载图表中...</p>
                </div>
                <div class="position-absolute top-0 end-0 m-2">
                    <button class="btn btn-sm btn-outline-secondary" onclick="resetZoom()">
                        <i class="bi bi-arrows-angle-expand"></i> 重置缩放
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Data -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar me-2"></i>近5日行情
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>日期</th>
                                <th>开盘</th>
                                <th>收盘</th>
                                <th>最高</th>
                                <th>最低</th>
                                <th>成交量</th>
                                <th>涨跌幅</th>
                            </tr>
                        </thead>
                        <tbody id="recentData">
                            <tr><td colspan="7" class="text-center py-4">加载中...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const stockCode = '{{ code }}';
let currentDays = 60;

document.addEventListener('DOMContentLoaded', function() {
    loadStockInfo();
    loadChart(currentDays);
});

async function loadStockInfo() {
    try {
        document.getElementById('stockName').textContent = '加载中...';
        const response = await fetch(`/api/stock_info/${stockCode}`);
        const result = await response.json();
        
        if (result.success) {
            displayInfo(result);
        } else {
            console.error('Failed to load stock info:', result.error);
            document.getElementById('stockName').textContent = result.error || '未知股票';
            
            // 显示错误信息和重试按钮
            document.getElementById('realtimeSection').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <h4 class="alert-heading">数据加载失败</h4>
                        <p>${result.error || '未找到股票数据'}</p>
                        <hr>
                        <p class="mb-0">
                            <button class="btn btn-primary" onclick="loadStockInfo()">
                                <i class="bi bi-arrow-clockwise me-2"></i>重试
                            </button>
                        </p>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load stock info:', error);
        document.getElementById('stockName').textContent = '加载失败';
        
        // 显示网络错误和重试按钮
        document.getElementById('realtimeSection').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center">
                    <h4 class="alert-heading">网络错误</h4>
                    <p>无法连接到服务器，请检查网络连接</p>
                    <hr>
                    <p class="mb-0">
                        <button class="btn btn-primary" onclick="loadStockInfo()">
                            <i class="bi bi-arrow-clockwise me-2"></i>重试
                        </button>
                    </p>
                </div>
            </div>
        `;
    }
}

function displayInfo(data) {
    const spot = data.spot;
    
    // Update name
    document.getElementById('stockName').textContent = spot?.['股票名称'] || '';
    
    // Update prices
    document.getElementById('currentPrice').textContent = spot?.['最新价'] || '-';
    
    const changePct = spot?.['涨跌幅'] || 0;
    const changeElem = document.getElementById('changePct');
    changeElem.textContent = (changePct > 0 ? '+' : '') + changePct + '%';
    changeElem.className = changePct > 0 ? 'metric-value text-danger' : 
                          changePct < 0 ? 'metric-value text-success' : 'metric-value';
    
    document.getElementById('highPrice').textContent = spot?.['最高价'] || '-';
    document.getElementById('lowPrice').textContent = spot?.['最低价'] || '-';
    
    // Update recent data
    const recentHtml = data.recent_data.map(item => `
        <tr>
            <td>${item.date}</td>
            <td>${item.open.toFixed(2)}</td>
            <td>${item.close.toFixed(2)}</td>
            <td>${item.high.toFixed(2)}</td>
            <td>${item.low.toFixed(2)}</td>
            <td>${item.volume.toLocaleString()}</td>
            <td class="${item.pct_change > 0 ? 'up' : 'down'}">${item.pct_change.toFixed(2)}%</td>
        </tr>
    `).join('');
    document.getElementById('recentData').innerHTML = recentHtml;
}

let chart = null;

// 初始化图表
function initChart(chartData) {
    const canvas = document.getElementById('chartCanvas');
    if (!canvas) {
        throw new Error('图表画布元素未找到');
    }
    
    const ctx = canvas.getContext('2d');
    if (!ctx) {
        throw new Error('无法获取画布上下文');
    }
    
    // 销毁旧图表
    if (chart) {
        chart.destroy();
        chart = null;
    }
    
    // 验证数据
    if (!chartData || !chartData.dates || !chartData.close) {
        throw new Error('图表数据格式不正确');
    }
    
    // 创建新图表
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.dates,
            datasets: [
                {
                    label: '收盘价',
                    data: chartData.close,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5
                },
                {
                    label: 'MA5',
                    data: chartData.ma5,
                    borderColor: '#e67e22',
                    backgroundColor: 'rgba(230, 126, 34, 0.1)',
                    borderWidth: 1,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                },
                {
                    label: 'MA10',
                    data: chartData.ma10,
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    borderWidth: 1,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                },
                {
                    label: 'MA20',
                    data: chartData.ma20,
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    borderWidth: 1,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
                axis: 'x'
            },
            layout: {
                padding: {
                    left: 10,
                    right: 20,
                    top: 20,
                    bottom: 20
                }
            },
            plugins: {
                zoom: {
                    pan: {
                        enabled: true,
                        mode: 'x',
                        threshold: 10
                    },
                    zoom: {
                        wheel: {
                            enabled: true,
                        },
                        pinch: {
                            enabled: true
                        },
                        mode: 'x',
                        threshold: 0.1
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: {
                        size: 14,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y.toFixed(2)}`;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    align: 'center',
                    labels: {
                        usePointStyle: true,
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                title: {
                    display: true,
                    text: `${stockCode} 价格走势图`,
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    align: 'center'
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: '日期',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: '价格',
                        font: {
                            size: 14,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2);
                        },
                        font: {
                            size: 11
                        }
                    }
                }
            },
            animation: {
                onComplete: function() {
                    // 图表动画完成后隐藏加载指示器
                    const placeholder = document.getElementById('chartPlaceholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                        placeholder.style.visibility = 'hidden';
                    }
                }
            }
        }
    });
    
    // 如果图表已经渲染完成（没有动画），立即隐藏加载指示器
    if (!chart.options.animation || !chart.options.animation.duration) {
        const placeholder = document.getElementById('chartPlaceholder');
        if (placeholder) {
            placeholder.style.display = 'none';
            placeholder.style.visibility = 'hidden';
        }
    }
}

// 重置缩放
function resetZoom() {
    if (chart) {
        chart.resetZoom();
    }
}

async function loadChart(days) {
    currentDays = days;
    
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(days + '天')) {
            btn.classList.add('active');
        }
    });
    
    // 显示加载中状态
    const placeholder = document.getElementById('chartPlaceholder');
    if (placeholder) {
        placeholder.style.display = 'flex';
        placeholder.style.visibility = 'visible';
        placeholder.innerHTML = `
            <div class="spinner mb-3"></div>
            <p>加载图表中...</p>
        `;
    }
    
    try {
        console.log('Loading chart for', stockCode, 'with', days, 'days');
        const response = await fetch(`/api/chart/${stockCode}?days=${days}&type=technical`);
        console.log('Chart API response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Chart API result:', result);
        
        if (result.success && result.data) {
            try {
                initChart(result.data);
                // 确保图表渲染完成后再隐藏加载指示器
                // 使用requestAnimationFrame确保DOM更新完成
                requestAnimationFrame(() => {
                    const placeholder = document.getElementById('chartPlaceholder');
                    if (placeholder) {
                        placeholder.style.display = 'none';
                        placeholder.style.visibility = 'hidden';
                    }
                });
            } catch (error) {
                console.error('Failed to initialize chart:', error);
                const placeholder = document.getElementById('chartPlaceholder');
                if (placeholder) {
                    placeholder.innerHTML = `
                        <div class="text-danger">
                            <i class="bi bi-exclamation-circle mb-3" style="font-size: 3rem;"></i>
                            <p>图表初始化失败</p>
                            <p class="small">${error.message || '未知错误'}</p>
                            <hr>
                            <button class="btn btn-primary" onclick="loadChart(${days})">
                                <i class="bi bi-arrow-clockwise me-2"></i>重试
                            </button>
                        </div>
                    `;
                    placeholder.style.display = 'flex';
                    placeholder.style.visibility = 'visible';
                }
            }
        } else {
            console.error('Failed to load chart:', result.error);
            document.getElementById('chartPlaceholder').innerHTML = `
                <div class="text-danger">
                    <i class="bi bi-exclamation-circle mb-3" style="font-size: 3rem;"></i>
                    <p>图表加载失败</p>
                    <p class="small">${result.error || '未找到图表数据'}</p>
                    <hr>
                    <button class="btn btn-primary" onclick="loadChart(${days})">
                        <i class="bi bi-arrow-clockwise me-2"></i>重试
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Failed to load chart:', error);
        document.getElementById('chartPlaceholder').innerHTML = `
            <div class="text-danger">
                <i class="bi bi-wifi-off mb-3" style="font-size: 3rem;"></i>
                <p>网络错误</p>
                <p class="small">无法连接到服务器</p>
                <hr>
                <button class="btn btn-primary" onclick="loadChart(${days})">
                    <i class="bi bi-arrow-clockwise me-2"></i>重试
                </button>
            </div>
        `;
    }
}

function analyzeStock() {
    window.location.href = `/analysis?code=${stockCode}`;
}

function addToCompare() {
    // Add to localStorage for comparison
    let compareList = JSON.parse(localStorage.getItem('compareList') || '[]');
    if (!compareList.includes(stockCode)) {
        compareList.push(stockCode);
        localStorage.setItem('compareList', JSON.stringify(compareList));
        alert('已加入对比列表');
    } else {
        alert('股票已在对比列表中');
    }
}

function refreshData() {
    loadStockInfo();
    loadChart(currentDays);
}
</script>
{% endblock %}